openapi: 3.0.3
info:
  title: TradeBaas API
  description: |
    REST API for TradeBaas 24/7 Automated Trading System
    
    **Iteration 7: Frontend Bridge & Status Modal**
    
    This API provides endpoints for:
    - Strategy status monitoring (real-time state)
    - Strategy lifecycle control (start/stop)
    - WebSocket for real-time updates
    
    **Important:** No trading actions are exposed in the frontend.
    All trading decisions are server-side only.
  version: 1.0.0
  contact:
    name: TradeBaas Development Team
    email: dev@tradebazen.nl

servers:
  - url: http://localhost:3000
    description: Local development server
  - url: https://api.tradebazen.nl
    description: Production server

tags:
  - name: Strategy
    description: Strategy lifecycle and status monitoring
  - name: Health
    description: Health check and readiness endpoints
  - name: WebSocket
    description: Real-time updates via WebSocket

paths:
  /api/strategy/status/v2:
    get:
      tags:
        - Strategy
      summary: Get current strategy status
      description: |
        Returns comprehensive strategy status including:
        - Strategy name and instrument
        - Current lifecycle state
        - Active/inactive status
        - Open position details (if any)
        - Metrics (uptime, trade statistics)
      operationId: getStrategyStatus
      responses:
        '200':
          description: Strategy status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyStatusResponse'
              examples:
                idle:
                  summary: No active strategy
                  value:
                    success: true
                    strategy:
                      name: null
                      instrument: null
                      state: "idle"
                      isActive: false
                      startedAt: null
                      lastTransition: 1699286400000
                      position: null
                    metrics:
                      uptime: 3600
                      tradesTotal: 0
                      tradesSuccess: 0
                      tradesFailed: 0
                active:
                  summary: Active strategy with position
                  value:
                    success: true
                    strategy:
                      name: "ema-rsi-scalper"
                      instrument: "BTC-PERPETUAL"
                      state: "position_open"
                      isActive: true
                      startedAt: 1699286400000
                      lastTransition: 1699286460000
                      position:
                        entryPrice: 35000
                        size: 100
                        side: "long"
                    metrics:
                      uptime: 3600
                      tradesTotal: 5
                      tradesSuccess: 4
                      tradesFailed: 1
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/strategy/start/v2:
    post:
      tags:
        - Strategy
      summary: Start a trading strategy
      description: |
        Starts the specified strategy on the given instrument.
        
        **Single Strategy Enforcement:**
        - Only ONE strategy can be active at a time
        - Returns error if strategy already running
        
        **Validation:**
        - strategyName must exist in registry
        - instrument must be valid (e.g., BTC-PERPETUAL)
      operationId: startStrategy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StrategyStartRequest'
            examples:
              emaRsiScalper:
                summary: Start EMA RSI Scalper on BTC
                value:
                  strategyName: "ema-rsi-scalper"
                  instrument: "BTC-PERPETUAL"
              bbMeanReversion:
                summary: Start BB Mean Reversion on ETH
                value:
                  strategyName: "bb-mean-reversion"
                  instrument: "ETH-PERPETUAL"
      responses:
        '200':
          description: Strategy started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyStartResponse'
              example:
                success: true
                message: "Strategy started successfully"
                strategy:
                  name: "ema-rsi-scalper"
                  instrument: "BTC-PERPETUAL"
                  state: "analyzing"
        '400':
          description: Bad request (validation error or strategy already active)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyStartResponse'
              examples:
                alreadyActive:
                  summary: Strategy already running
                  value:
                    success: false
                    message: "Failed to start strategy"
                    error: "Single strategy violation: Strategy 'ema-rsi-scalper' is already running"
                missingField:
                  summary: Missing required field
                  value:
                    success: false
                    message: "Failed to start strategy"
                    error: "strategyName and instrument are required"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/strategy/stop/v2:
    post:
      tags:
        - Strategy
      summary: Stop the active trading strategy
      description: |
        Stops the currently active strategy.
        
        **Behavior:**
        - Stops strategy analysis
        - Does NOT close open positions (handled by strategy lifecycle)
        - Returns error if no strategy is active
      operationId: stopStrategy
      responses:
        '200':
          description: Strategy stopped successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyStopResponse'
              example:
                success: true
                message: "Strategy 'ema-rsi-scalper' stopped successfully"
        '400':
          description: No active strategy to stop
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StrategyStopResponse'
              example:
                success: false
                message: "Failed to stop strategy"
                error: "No active strategy to stop"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns service health status
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /ready:
    get:
      tags:
        - Health
      summary: Readiness check endpoint
      description: Returns service readiness status
      operationId: getReady
      responses:
        '200':
          description: Service is ready
        '503':
          description: Service is not ready

components:
  schemas:
    StrategyStatusResponse:
      type: object
      required:
        - success
        - strategy
        - metrics
      properties:
        success:
          type: boolean
          description: Whether the request was successful
          example: true
        strategy:
          type: object
          required:
            - name
            - instrument
            - state
            - isActive
            - startedAt
            - lastTransition
            - position
          properties:
            name:
              type: string
              nullable: true
              description: Name of active strategy (null if no strategy active)
              example: "ema-rsi-scalper"
            instrument:
              type: string
              nullable: true
              description: Trading instrument (null if no strategy active)
              example: "BTC-PERPETUAL"
            state:
              type: string
              description: Current lifecycle state
              enum:
                - idle
                - analyzing
                - signal
                - entry
                - position_open
                - closed
              example: "analyzing"
            isActive:
              type: boolean
              description: Whether strategy is currently active
              example: true
            startedAt:
              type: integer
              nullable: true
              description: Unix timestamp when strategy started (ms)
              example: 1699286400000
            lastTransition:
              type: integer
              description: Unix timestamp of last state transition (ms)
              example: 1699286460000
            position:
              type: object
              nullable: true
              description: Open position details (null if no position)
              properties:
                entryPrice:
                  type: number
                  description: Entry price
                  example: 35000
                size:
                  type: number
                  description: Position size (contracts)
                  example: 100
                side:
                  type: string
                  enum: [long, short]
                  description: Position direction
                  example: "long"
        metrics:
          type: object
          required:
            - uptime
            - tradesTotal
            - tradesSuccess
            - tradesFailed
          properties:
            uptime:
              type: number
              description: Backend uptime in seconds
              example: 3600
            tradesTotal:
              type: integer
              description: Total number of trades executed
              example: 5
            tradesSuccess:
              type: integer
              description: Number of successful trades
              example: 4
            tradesFailed:
              type: integer
              description: Number of failed trades
              example: 1

    StrategyStartRequest:
      type: object
      required:
        - strategyName
        - instrument
      properties:
        strategyName:
          type: string
          description: Name of strategy to start
          example: "ema-rsi-scalper"
        instrument:
          type: string
          description: Trading instrument
          example: "BTC-PERPETUAL"

    StrategyStartResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: Whether strategy started successfully
          example: true
        message:
          type: string
          description: Success or error message
          example: "Strategy started successfully"
        strategy:
          type: object
          description: Strategy details (present on success)
          properties:
            name:
              type: string
              example: "ema-rsi-scalper"
            instrument:
              type: string
              example: "BTC-PERPETUAL"
            state:
              type: string
              example: "analyzing"
        error:
          type: string
          description: Error details (present on failure)
          example: "Strategy already running"

    StrategyStopResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          description: Whether strategy stopped successfully
          example: true
        message:
          type: string
          description: Success or error message
          example: "Strategy 'ema-rsi-scalper' stopped successfully"
        error:
          type: string
          description: Error details (present on failure)
          example: "No active strategy to stop"

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Overall health status
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp

    ErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error message
          example: "Internal server error"

  # WebSocket Protocol Documentation
  x-websocket-endpoints:
    /ws/analysis:
      description: |
        Real-time strategy updates via WebSocket
        
        **Connection:**
        ```javascript
        const ws = new WebSocket('ws://localhost:3001');
        ```
        
        **Client → Server Messages:**
        
        1. **Subscribe to strategy updates:**
        ```json
        {
          "type": "subscribe",
          "channel": "strategy"
        }
        ```
        
        2. **Heartbeat (ping):**
        ```json
        {
          "type": "ping"
        }
        ```
        
        **Server → Client Messages:**
        
        1. **Strategy Update (sent every 1s + on state change):**
        ```json
        {
          "type": "strategyUpdate",
          "timestamp": 1699286460000,
          "data": {
            "strategyName": "ema-rsi-scalper",
            "instrument": "BTC-PERPETUAL",
            "state": "analyzing",
            "isActive": true,
            "position": {
              "entryPrice": 35000,
              "size": 100,
              "side": "long"
            }
          }
        }
        ```
        
        2. **Pong (heartbeat response):**
        ```json
        {
          "type": "pong",
          "timestamp": 1699286460000
        }
        ```
        
        3. **Error:**
        ```json
        {
          "type": "error",
          "error": "Invalid message format",
          "timestamp": 1699286460000
        }
        ```
        
        **Update Frequency:**
        - Periodic: Every 1 second
        - Event-driven: On strategy state change
        - Latency: <50ms (target)
        
        **Connection Management:**
        - Auto-reconnect on disconnect (client responsibility)
        - No authentication required (localhost/internal network)
        - Max connections: Unlimited
